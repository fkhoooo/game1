var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,r){return new(i||(i=Promise))(function(n,o){function a(t){try{c(r.next(t))}catch(e){o(e)}}function s(t){try{c(r["throw"](t))}catch(e){o(e)}}function c(t){t.done?n(t.value):new i(function(e){e(t.value)}).then(a,s)}c((r=r.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return r([t,e])}}function r(i){if(n)throw new TypeError("Generator is already executing.");for(;c;)try{if(n=1,o&&(a=o[2&i[0]?"return":i[0]?"throw":"next"])&&!(a=a.call(o,i[1])).done)return a;switch(o=0,a&&(i=[0,a.value]),i[0]){case 0:case 1:a=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,o=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(a=c.trys,!(a=a.length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){c.label=i[1];break}if(6===i[0]&&c.label<a[1]){c.label=a[1],a=i;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(i);break}a[2]&&c.ops.pop(),c.trys.pop();continue}i=e.call(t,c)}catch(r){i=[6,r],o=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var n,o,a,s,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},P2Sprite=function(){function t(t){this.id=t}return t.prototype.createSprite=function(t){this.entity=t,this.box=new p2.Box({width:t.width/P2World.factor,height:t.height/P2World.factor}),this.box.material=t.material,this.body=new p2.Body({mass:t.mass}),this.body.position=[t.x/P2World.factor,(egret.MainContext.instance.stage.stageHeight-t.y)/P2World.factor],this.body.addShape(this.box),this.body.displays=[t],this.body.angle=Tools.getAngle(t.getAngle()),this.body.velocity=Tools.getVelocity(t.velocity),this.body.damping=0,P2World.getInstance().world.addBody(this.body)},t.prototype.dispose=function(){P2World.getInstance().world.removeBody(this.body),this.entity.dispose()},t}();__reflect(P2Sprite.prototype,"P2Sprite");var P2World=function(){function t(){}return t.getInstance=function(){return t.instance||(t.instance=new t,t.instance.init()),t.instance},t.prototype.init=function(){this.world=new p2.World,this.world.applyGravity=!1,this.initMaterial(),this.initEvent()},t.prototype.initEvent=function(){this.world.on("beginContact",this.onBeginContact,this),this.world.on("endContact",this.onEndContact),egret.startTick(this.update,this)},t.prototype.update=function(e){void 0===e&&(e=1),this.world.step(.06);for(var i=this.world.bodies.length,r=0;i>r;r++){var n=this.world.bodies[r];if(n&&n.displays[0]){var o=n.displays[0];o&&(o.x=n.position[0]*t.factor,o.y=egret.MainContext.instance.stage.stageHeight-n.position[1]*t.factor,o.rotation=360-180*(n.angle+n.shapes[0].angle)/Math.PI,!o.isClear&&o.isOutSide()&&(o.isClear=!0,Dispatch.dispatch(CarGame.OUT_SIDE,o.id)))}}},t.prototype.initMaterial=function(){this.carMaterial=new p2.Material(1),this.trainMaterial=new p2.Material(2);var t=new p2.ContactMaterial(this.carMaterial,this.carMaterial);t.friction=.5,t.restitution=.9,this.world.addContactMaterial(t);var e=new p2.ContactMaterial(this.carMaterial,this.trainMaterial);e.friction=.7,e.restitution=.7,this.world.addContactMaterial(e)},t.prototype.onBeginContact=function(t){var e=t.bodyA,i=t.bodyB;t.shapeA,t.shapeB,e.displays[0],i.displays[0];e.damping=.5,i.damping=.5,e.angularDamping=.5,i.angularDamping=.5},t.prototype.onEndContact=function(t){var e=t.bodyA,i=t.bodyB,r=e.displays[0],n=i.displays[0];r&&n&&Dispatch.dispatch(CarGame.GAME_OVER)},t.prototype.dispose=function(){this.carMaterial=null,this.trainMaterial=null,this.world.off("beginContact",this.onBeginContact),this.world.off("endContact",this.onEndContact),egret.stopTick(this.update,this)},t.factor=50,t}();__reflect(P2World.prototype,"P2World");var CarFactory=function(){function t(){this.carPool=[],this.num=0}return t.getIntance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.createCar=function(t,e){var i,r=this.carPool.shift(),n=Math.ceil(2*Math.random());r?i=r.entity:(this.num++,r=new Car(this.num),i=new Entity,i.id=this.num);var o=CarJson_json.getData(n);return i.setData(e,t,this.getTexture(o.icon+"")),i.mass=o.mass,i.setVelocity(1),i.material=P2World.getInstance().carMaterial,r.createSprite(i),r},t.prototype.getTexture=function(t){var e=RES.getRes("car_json");return e.getTexture(t)},t.prototype.recoverCar=function(t){this.carPool.length<20&&this.carPool.push(t)},t}();__reflect(CarFactory.prototype,"CarFactory");var CarGame=function(t){function e(){var e=t.call(this)||this;return e.spriteList={},e.roadDataList=[],e.initEvent(),P2World.getInstance().init(),e.createRoadData(),e.createCar(),e}return __extends(e,t),e.prototype.initEvent=function(){Dispatch.register(e.GAME_OVER,this.gameOver,this),Dispatch.register(e.OUT_SIDE,this.outSide,this)},e.prototype.createRoadData=function(){this.roadDataList[0]=RoadData.getRoad(0,500),this.roadDataList[1]=RoadData.getRoad(1,300)},e.prototype.createCar=function(){var t=this;egret.setInterval(function(){var e=Math.floor(2*Math.random()),i=CarFactory.getIntance().createCar(t,t.roadDataList[e]);t.spriteList[i.id]=i},this,1500)},e.prototype.outSide=function(t){CarFactory.getIntance().recoverCar(this.spriteList[t]),this.spriteList[t]&&(this.spriteList[t].dispose(),delete this.spriteList[t])},e.prototype.gameOver=function(){console.log("游戏结束")},e.GAME_OVER="GAME_OVER",e.OUT_SIDE="OUT_SIDE",e}(egret.DisplayObjectContainer);__reflect(CarGame.prototype,"CarGame");var Entity=function(t){function e(){var e=t.call(this)||this;return e.velocity=[],e.max_velocity=[],e.force=[],e}return __extends(e,t),e.prototype.setData=function(t,e,i){this.roadData=t,this.skin||(this.skin=new egret.Bitmap,this.skin.touchEnabled=!0),this.skin.texture=i,this.width=i.textureWidth,this.height=i.textureHeight,this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2;var r=this.getBeginPos();this.x=r[0],this.y=r[1],this.addChild(this.skin),e.addChild(this),this.isClear=!1},e.prototype.getBeginPos=function(){switch(this.roadData.type){case 0:return[Main.stageWidth+this.width,Math.floor(Math.random()*this.roadData.roadWidth+this.roadData.position)];case 1:return[Math.floor(Math.random()*this.roadData.roadWidth+this.roadData.position),Main.stageHeight+this.height];case 2:return[-this.width,Math.floor(Math.random()*this.roadData.roadWidth+this.roadData.position)];case 3:return[Math.floor(Math.random()*this.roadData.roadWidth+this.roadData.position),-this.height]}},e.prototype.getAngle=function(){switch(this.roadData.type){case 0:return 0;case 1:return 270;case 2:return 180;case 3:return 90}},e.prototype.setVelocity=function(t){switch(this.roadData.type){case 0:this.velocity=[-1*t,0];break;case 1:this.velocity=[0,-1*t];break;case 2:this.velocity=[t,0];break;case 3:this.velocity=[0,t]}},e.prototype.setForce=function(t){switch(this.roadData.type){case 0:this.force=[-1*t,0];break;case 1:this.force=[0,-1*t];break;case 2:this.force=[t,0];break;case 3:this.force=[0,t]}},e.prototype.isOutSide=function(){switch(this.roadData.type){case 0:return this.x<0;case 1:return this.y<0;case 2:return this.x>Main.stageWidth;case 3:return this.y>Main.stageHeight}},e.prototype.dispose=function(){this.force=[0,0],this.skin&&this.removeChild(this.skin),this.parent&&this.parent.removeChild(this)},e}(egret.DisplayObjectContainer);__reflect(Entity.prototype,"Entity");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){e.stageWidth=egret.MainContext.instance.stage.stageWidth,e.stageHeight=egret.MainContext.instance.stage.stageHeight;new p2.World;this.runGame()},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.loadResource()];case 1:return t.sent(),[4,this.loadJson()];case 2:return t.sent(),this.createGameScene(),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return i.sent(),this.stage.removeChild(t),[3,4];case 3:return e=i.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.loadJson=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,r,n,o,a;return __generator(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadGroup("preloadJson",0,t)];case 1:for(s.sent(),this.stage.removeChild(t),e=RES.getGroupByName("preloadJson"),i=0;i<e.length;i++)r=e[i].name,n=r.charAt(0).toUpperCase()+r.slice(1),o=egret.getDefinitionByName(n),o&&o.decodeJson(RES.getRes(r));return[3,3];case 2:return a=s.sent(),console.error(a),[3,3];case 3:return[2]}})})},e.prototype.createGameScene=function(){this.stage.addChild(new CarGame)},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,i){function r(r){e.call(i,r,t)}if(RES.hasRes(t)){var n=RES.getRes(t);n?r(n):RES.getResAsync(t,r,this)}else RES.getResByUrl(t,r,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var Car=function(t){function e(e){var i=t.call(this,e)||this;return i.lastVelocity=[],i.lastForce=[],i}return __extends(e,t),e.prototype.createSprite=function(e){t.prototype.createSprite.call(this,e),this.isPause=!1,this.entity.addEventListener(egret.TouchEvent.TOUCH_TAP,this.beginTouch,this)},e.prototype.beginTouch=function(t){this.isPause=!this.isPause,this.isPause?(this.lastVelocity=this.body.velocity.concat(),this.body.velocity=[0,0],this.lastForce=this.entity.force.concat(),this.entity.force=[0,0],this.body.force=[0,0]):(this.body.velocity=this.lastVelocity,this.entity.force=this.lastForce)},e.prototype.dispose=function(){this.entity.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.beginTouch,this),t.prototype.dispose.call(this)},e}(P2Sprite);__reflect(Car.prototype,"Car");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var RoadData=function(){function t(t,e){this.position=200,this.roadWidth=200,this.type=t,this.position=e}return t.getRoad=function(e,i){var r=[[0,2],[1,3]],n=r[e][Math.floor(2*Math.random())];return new t(n,i)},t}();__reflect(RoadData.prototype,"RoadData");var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,i,r){function n(t){e.call(r,t)}function o(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),i.call(r))}var a=this;if("undefined"!=typeof generateEUI)egret.callLater(function(){e.call(r,generateEUI)},this);else if("undefined"!=typeof generateEUI2)RES.getResByUrl("resource/gameEui.json",function(t,i){window.JSONParseClass.setData(t),egret.callLater(function(){e.call(r,generateEUI2)},a)},this,RES.ResourceItem.TYPE_JSON);else if("undefined"!=typeof generateJSON)if(t.indexOf(".exml")>-1){var s=t.split("/");s.pop();var c=s.join("/")+"_EUI.json";generateJSON.paths[t]?egret.callLater(function(){e.call(r,generateJSON.paths[t])},this):RES.getResByUrl(c,function(i){window.JSONParseClass.setData(i),egret.callLater(function(){e.call(r,generateJSON.paths[t])},a)},this,RES.ResourceItem.TYPE_JSON)}else egret.callLater(function(){e.call(r,generateJSON)},this);else RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),RES.getResByUrl(t,n,this,RES.ResourceItem.TYPE_TEXT)},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var Tools=function(){function t(){}return t.getVelocity=function(t){var e=t;return[e[0],-e[1]]},t.getForce=function(t){var e=t;return[e[0],-e[1]]},t.getAngle=function(t){return Math.PI/180*t},t}();__reflect(Tools.prototype,"Tools");var Dispatch=function(){function t(){this.observers=[]}return t.getInstance=function(){return null==this.instance&&(this.instance=new t),this.instance},t.prototype.add=function(t,e,i,r){void 0===r&&(r=!1);var n=this.observers[t];if(null!=e&&r&&e.apply(i),null==n)n=[],this.observers[t]=n;else if(-1!=this.getCallIdx(n,e,i))return;n.push(new DispatchItemData(e,i))},t.prototype.getCallIdx=function(t,e,i){for(var r=0;r<t.length;r++)if(t[r].call==e&&t[r].thisObj==i)return r;return-1},t.prototype.remove=function(t,e,i){var r=this.observers[t];if(r){var n=this.getCallIdx(r,e,i);-1!=n&&(r[n].call=null,r[n].thisObj=null,r.splice(n,1)),r.length<=0&&(this.observers[t]=null,delete this.observers[t])}},t.prototype.execute=function(t,e){var i=this.observers[t];if(i){i=i.concat();for(var r=[],n=0;n<i.length;n++)r[n]=i[n];for(var o=0;o<r.length;o++){var a=r[o],s=a.call,c=a.thisObj;null!=s&&null!=c&&(0==e.length?s.apply(c,null):s.apply(c,e))}}},t.dispatch=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this.getInstance().execute(t,e)},t.register=function(t,e,i,r){void 0===r&&(r=!1),this.getInstance().add(t,e,i,r)},t.remove=function(t,e,i){this.getInstance().remove(t,e,i)},t}();__reflect(Dispatch.prototype,"Dispatch");var DispatchItemData=function(){function t(t,e){this.call=t,this.thisObj=e}return t}();__reflect(DispatchItemData.prototype,"DispatchItemData");var CarJson_json=function(){function t(){}return t.getData=function(t){var e=t+"";return this.dataList[e]},t.decodeJson=function(t){for(var e in t){for(var i=t[e],r="",n=0;n<this.key.length;n++)r+=i[this.key[n]]+(n==this.key.length-1?"":"_");this.dataList[r]=i}},t.dataList={},t.key=["id"],t}();__reflect(CarJson_json.prototype,"CarJson_json"),window.CarJson_json=CarJson_json;